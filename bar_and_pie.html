<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title> INFO 3300 - Project 2</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>

    <style>
    .banner {
        width: 70%;
        margin-bottom: 2%;
        margin-left: auto;
        margin-right: auto;
        justify-content: center;
        height: 200px;
    }

    text {
        font-family: Century Gothic, CenturyGothic, AppleGothic, sans-serif;
    }

    .svgs {
        display: flex;
        flex-direction: row;
    }

    .svgandbuttons {
        display: flex;
        flex-direction: row;
    }

    .company_buttons {
      background-color: #e7e7e7;
      text-align: center;
      /* margin: 30px; */
      padding-right: 30px;
      padding-left: 30px;
      padding-top: 10px;
      padding-bottom: 10px;
      margin-top: -5%;
    }

    .c_buttons {
        display: flex;
        flex-direction: column;
        flex-wrap: wrap;
        margin: 5px;
        font-size: 12px;
        background-color: inherit;
        font-family: Century Gothic, CenturyGothic, AppleGothic, sans-serif;
        border: none;
        outline: none;
        padding: 10px 20px;
        transition: 0.2s;
    }

    button:hover {
      background-color: #b8b8b8;
    }

    .svgs text {
        font-family: Arial, Helvetica, sans-serif;
        font-size: 10px;
    }

    svg text {
        font-size: 12px;
    }

    img {
        width: 40%;
        display: block;
    }

    .tab {
        overflow: hidden;
        border: 2px solid black;
        background-color: #f1f1f1;
        margin-bottom: 20px;
     }

    .tab button {
        float: left;
        border: none;
        outline: none;
        cursor: default;
        padding: 10px 20px;
        transition: 0.2s;
        font-family: Century Gothic, CenturyGothic, AppleGothic, sans-serif;
    }

    .tab button:hover {
        background-color: #b8b8b8;
    }

    .tab button.active {
        background-color: #ccc;
    }

    .chartlegend {
        margin-left: 20px;
    }

    /* .c_buttons {
        width: 80px;
        height: 25px;
        margin: 5px;
        border: 2px solid #172a61;
        background-color: #ffefdf;
        color: #172a61;
        padding: 3px;
    } */

    .all {
      display: flex;
      flex-direction: column;
    }

    .headers {
      display: flex;
      flex-direction: row;
      margin-top: -2%;
      width: 75%;
    }

    .barCaption {
      margin-right: 20px;
    }
    </style>

  </head>
    <body>
        <!-- add project logo -->
        <img src="project-logo.png" alt = "Silicon Valley Project logo" class = "banner">

        <!-- create buttons -->
        <div id="button-bar" class = "tab"></div>

        <div class = 'all'>
          <!-- create titles -->
          <div class="headers">
            <div class= "barCaption">
              <h3 id= 'barTitle'></h3>
              <p id= 'barCap'></p>
            </div>
            <div class= "pieCaption">
              <h3 id= 'pieTitle'></h3>
              <p id= 'pieCap'></p>
            </div>
          </div>

          <!-- create legend -->
          <div class = "chartlegend">
              <svg id="legend" height="15" width ="550"></svg>
          </div>

          <div class = 'svgandbuttons'>
          <!-- create svg -->
            <div class= 'svgs' id = 'svgs'>
              <svg id="stackedBar" height="400" width = "600"></svg>
            </div>

            <!-- create company buttons -->
            <div id="company-buttons" class= "company_buttons"></div>
          </div>

          <!-- create hover -->
          <div id="label"></div>
        </div>

        <!-- get data -->
        <script>
            let svg = d3.select("svg#stackedBar");

            //get height and width
            var height = svg.attr("height")
            var width = svg.attr("width")

            //create margins and adjust chart
            const margins = {"top": 10, "right": 50, "bottom": 80, "left": 50};
            const chartWidth = width - margins.left - margins.right;
            const chartHeight = height - margins.top - margins.bottom;


            //get color scales
            // used optimization tool: http://vrl.cs.brown.edu/color
            var colorOptions = { "Race": ["#ffa600", "#003f5c", "#ff6361", "#58508d", "#bc5090"], "Gender": ["blue", "pink"] };
            var colorOptions2 = { "Race": ["#ff6361", "#ffa600", "#58508d", "#003f5c", "#bc5090"], "Gender": ["blue", "pink"] };
            var key = ["Race", "Gender"];
            var keys = { "Race": [" % White ", " % Asian ", " % Latino ", " % Black ", " % Multi "], "Gender": [" Male % ", " Female % "]};
            var barTitles = {'Race': "Breakdown of Employees’ Races in Top Tech Companies", 'Gender': "Breakdown of Employee Gender in Top Tech Companies"}
            var barCaptions = {'Race': "Compares the proportion of each technology company’s employee body represented by each respective race. Which companies employ the smallest percentage of minorities? Which companies hire a fair representation of employees from all backgrounds?", 'Gender': "Compares the proportion of each technology company’s employee body represented by men and women. While STEM fields continue to be dominated by men, does this trend bleed into the Silicon Valley tech companies?"}
            // var pieTitles = {'Race': }
            var pieCaptions = {'Race': 'Is there fair representation of all backgrounds as top executives and senior managers? Looking at the total employee diversity is important, but we must also ensure that there is adequate diversity in the highest ranks and among the decision makers.', 'Gender': 'Is there fair representation of females as top executives and senior managers? In a field still overly represented by men, how many tech change-makers are women?'}

            //get barchart area
            let annotations = svg.append("g").attr("id","annotations");
            let stackedBar = svg.append("g")
                    .attr("transform","translate(25,"+margins.top+")");

            // create axis
            const percentScale = d3.scaleLinear().domain([0,1]).range([chartHeight, 0]);
            let leftAxis = d3.axisLeft(percentScale).tickFormat(d3.format('.0%'));

            annotations.append("g")
                       .attr("class", "y axis")
                       .attr("transform",`translate(${margins.left},${margins.top})`)
                       .call(leftAxis)

            //get data
            d3.csv("group_company_final.csv", d3.autoType)
                .then((data) => {

                    // console.log(data)

                    const requestData = async () => {

                      const pData = await d3.csv("eeo1-2015-2016.csv");
                      // console.log(pData)

                      let positionData = pData.filter( (d) => {return (d['company'] === "Apple" || d['company'] === "Cisco" || d['company'] === "Facebook" || d['company'] === "Google" || d['company'] === "Intel" || d['company'] === "LinkedIn" || d['company'] === "Nvidia" || d['company'] === "Pinterest" || d['company'] === "Salesforce" || d['company'] === "Twitter" || d['company'] === "Uber" || d['company'] === "eBay") });
                      positionData.forEach( (d,i) => {
                        d['year'] = Number(d['Year']);
                        d['count'] = Number(d['count']);
                      });
                      positionData = positionData.filter( (d) => {return d['year'] = 2016});

                      const positions = d3.map(positionData, d => d.job_category)
                      var distinctP = new Set(positions)

                      const prace = d3.map(positionData, d => d.race)
                      const distinctRace = new Set(prace)

                      const r1tor2 = {" % White ": "White", " % Asian ": "Asian", " % Latino ": "Hispanic_or_Latino", " % Black ": "Black_or_African_American", " % Multi ": "Two_or_more_races"}
                      // console.log(r1tor2[" % White "])
                      // filter to just get 1 year
                      data = data.filter( (d) => {return d['Date'] === "Jan 2018"});

                      const companies = d3.map(data, d => d.company);
                      // console.log(companies)


                      let racedatastructure = {};
                      companies.forEach ( (c) => {
                        let positionStructure = {};
                        distinctP.forEach( (p) => {
                          let raceStructure = {};
                          distinctRace.forEach( (r) => {
                            let rdata = positionData.filter( (d) => {return d['job_category'] === p && d['company'] === c && d['race'] === r});
                            let count = 0;
                            rdata.forEach( (rd) => {
                              count = count + rd['count']
                            });
                            raceStructure[r] = count;
                          });
                          positionStructure[p] = raceStructure;
                        });
                        racedatastructure[c] = positionStructure;
                      });

                      let distinctGender = ['male', 'female']
                      let genderdatastructure = {};
                      companies.forEach ( (c) => {
                        let positionStructure = {};
                        distinctP.forEach( (p) => {
                          let genderStructure = {};
                          distinctGender.forEach( (r) => {
                            let rdata = positionData.filter( (d) => {return d['job_category'] === p && d['company'] === c && d['gender'] === r});
                            let count = 0;
                            rdata.forEach( (rd) => {
                              count = count + rd['count']
                            });
                            genderStructure[r] = count;
                          });
                          positionStructure[p] = genderStructure;
                        });
                        genderdatastructure[c] = positionStructure;
                      });

                      let pDataStructure = {'Race': racedatastructure, 'Gender': genderdatastructure};

                      const companyScale = d3.scaleBand().domain(companies).range([5, chartWidth-margins.right])
                                                       .padding(0.05);


                      let bottomAxis = d3.axisBottom(companyScale);
                      annotations.append("g")
                                   .attr("class", "x axis")
                                   .attr("transform",`translate(${margins.left},${chartHeight+margins.top+10})`)
                                   .call(bottomAxis)
                                  .selectAll("text")
                                    .attr("y", 0)
                                    .attr("x", 9)
                                    .attr("dy", ".35em")
                                    .attr("transform", "rotate(90)")
                                    .style("text-anchor", "start");

                      const barScale = d3.scaleLinear().domain([0,11]).range([margins.left, chartWidth-margins.right])

                      const heightScale = d3.scaleLinear().domain([0,1]).range([0, chartHeight])

                      function pieChart(filterType, company) {

                        d3.select("svg#default").remove();
                        d3.select('h3#pieTitle').selectAll('text').remove();

                        let pieTitles = {'Race': 'The Top Executives at '+ company + ' by '+ filterType +'', 'Gender': 'The Top Executives at '+ company + ' by '+ filterType +''};
                        console.log(pieTitles[filterType])
                        d3.select('h3#pieTitle').append('text')
                                                .text(pieTitles[filterType])


                        var data = pDataStructure[filterType][company]['Executives']

                        var pwidth = 600
                        var pheight = 400
                        var pmargin = 50

                        var radius = Math.min(pwidth, pheight) / 2 - pmargin

                        var svg = d3.select("#svgs")
                          .append("svg")
                            .attr("width", pwidth)
                            .attr("height", pheight)
                            .attr('id', 'pie')
                          .append("g")
                            .attr("transform", "translate(" + (pwidth-3*pmargin) / 2 + "," + (pheight-pmargin) / 2 + ")");

                        var color = d3.scaleOrdinal(colorOptions2[filterType]);
                        var pie = d3.pie()
                          .value(function(d) {return d.value; })

                        var mapped = [];
                        Object.keys(data).forEach( d => {
                          if (d !== "Overall_totals" && d !== "Native_Hawaiian_or_Pacific_Islander" && d !== "American_Indian_Alaskan_Native") {
                            var map = {}
                            map.key = d;
                            map.value = data[d];
                            mapped.push(map);
                          }
                        });

                        var data_ready = pie(mapped)
                        console.log(data_ready)

                        let test = svg
                          .selectAll('whatever')
                          .data(data_ready)
                          .enter()
                          .append('path')
                          .attr('d', d3.arc()
                            .innerRadius(0)
                            .outerRadius(radius)
                          )
                          .attr('fill', function(d){ return(color(d.data.key)) })
                          .attr("stroke", "black")
                          .attr("id", d=> d.data.key + ': ' + Math.round((d.endAngle - d.startAngle)/(2*Math.PI)*100,4) + '%')
                          //.attr("id", d => (d.data.key + (d.data.endAngle - d.data.startAngle)/(2*Math.PI)*100))
                          //.attr("id", function(d){ return(d.endAngle - d.startAngle)/(2*Math.PI)*100 })
                          .style("stroke-width", "2px")
                          .style("opacity", 0.7)
                          .on("mouseover", function() {
                            d3.select(this)
                              .style('stroke-width', '5px')
                              .style("opacity", 1)

                            d3.select('#pie')
                              .append('text')
                              .text(this.id)
                              .style("text-anchor", "start")
                              .attr('y', -60)
                              //console.log(this.id)
                              // .text((d.endAngle - d.startAngle)/(2*Math.PI)*100)
                              .attr('id', 'race_label')
                              .attr('transform',`translate(${pmargin},${(pheight-pmargin*5)/2})`)
                              .style('font-family', 'Century Gothic, CenturyGothic, AppleGothic, sans-serif')
                          })
                          .on("mouseout", function() {
                            d3.select(this)
                              .style('stroke-width', '2px')
                              .style("opacity", .7)

                            d3.select('#race_label').remove('text')
                          });

                      };

                      function updateBarsAnimated(filterType) {

                        svg.selectAll("line").remove();
                        let ft = keys[filterType];
                        let colors = colorOptions[filterType];
                        //loop through each company
                        data.forEach ((d,i) => {
                          // console.log(d)
                          var newHeight = chartHeight
                          // loop through each race
                          let companyRect = stackedBar.append('g')
                                                      .attr('label', d.company);

                          ft.forEach((race, spot) => {
                            if (race !== " % Undeclared ") {
                              let r = r1tor2[race];
                              // console.log(r)
                              //append rectangle
                              let line = companyRect.append("line")
                                                    .attr("x1", barScale(i))
                                                    .attr("y1", newHeight)
                                                    .attr("y2", newHeight- ((d[race])/100)*chartHeight)
                                                    .attr("x2", barScale(i))
                                                    .attr("stroke", colors[spot])
                                                    .attr("stroke-width", 20)
                                                    .attr("label", race);

                              newHeight = newHeight - ((d[race])/100)*chartHeight;

                              companyRect.on("mouseover", function() {
                                d3.select("svg#pie").remove();
                                pieChart(filterType, d.company);
                              });



                              line.on("mouseover", function() {
                                d3.select(this)
                                    .transition().duration(200)
                                    .attr("stroke-width", 30);

                                d3.select("#label")
                                  .text(race+": "+Math.round(d[race])+"%");
                              });

                              line.on("mouseout", function() {

                                d3.select(this)
                                    .transition().duration(200)
                                    .attr("stroke-width", 20);

                                d3.select("#label")
                                  .text("");

                              });
                            };

                          });

                        });

                      };

                      function updateLegend(filterType) {
                        let legend = d3.select("svg#legend");
                        let captions = d3.select('div.headers');

                        let legWidth = legend.attr('width');
                        let legHeight = legend.attr('height')
                        legend.selectAll("text").remove();
                        legend.selectAll("rect").remove();
                        captions.selectAll("text").remove();



                        let ft = keys[filterType];
                        let colors = colorOptions[filterType];
                        console.log(filterType)
                        console.log(barTitles[filterType])

                        d3.select('h3#barTitle').append('text').text(barTitles[filterType])
                        d3.select('p#barCap').append('text').text(barCaptions[filterType])
                        d3.select('p#pieCap').append('text').text(pieCaptions[filterType])

                        const legendRectScale = d3.scaleLinear().domain([0, ft.length]).range([0, legWidth-50])
                        const legendTextScale = d3.scaleLinear().domain([0, ft.length]).range([20, legWidth-40])
                        ft.forEach( (d,i)  => {
                          let color = colors[i];
                          let rectangle = legend.append("rect")
                                                .attr('x', legendRectScale(i))
                                                .attr('y', 5)
                                                .attr('width', legHeight-5)
                                                .attr('height', legHeight-5)
                                                .attr('fill', color);
                          let text = legend.append("text")
                                            .text(d)
                                            .attr('x', legendTextScale(i))
                                            .attr('y', legHeight)
                                            .attr('fill', color);

                        });

                      };
                      companies.forEach( d => {
                        d3.select("div#company-buttons")
                          .append("button")
                          .text(d)
                          .attr('id', d)
                          .attr('class', 'c_buttons');
                      });

                      function updateButtons(filterType) {
                        let cr_buttons = companies.forEach( d => {
                        d3.select('button#'+d)
                          .on('click', function() {
                            d3.select("svg#pie").remove();
                            pieChart(filterType, d)
                          });
                        });

                      };


                      key.forEach( d => {

                          // For each year key, add a new button to the button bar
                          d3.select("div#button-bar")
                            .append("button")
                            .text( d )
                            .on("click", function() {
                              // When it's clicked, call updateBars to update the chart
                              d3.select("svg#pie").remove();
                              d3.select("svg#default").remove();
                              // pieChart(d, 'Apple')
                              d3.select('div#svgs').append('svg')
                                                    .attr('id', 'default')
                                                    .attr('width', 600)
                                                    .attr('height', 400)
                                                  .append('circle')
                                                    .attr('cx', 0)
                                                    .attr('cy', 0)
                                                    .attr('r', 150)
                                                    .style('fill', 'none')
                                                    .style('stroke', 'black')
                                                    .attr("transform", "translate(" + (600-3*50) / 2 + "," + (400-50) / 2 + ")");
                              updateBarsAnimated( d );
                              updateLegend( d );
                              updateButtons( d );
                            })
                        });

                        // pieChart('Race', 'Apple')
                        d3.select('div#svgs').append('svg')
                                              .attr('id', 'default')
                                              .attr('width', 600)
                                              .attr('height', 400)
                                            .append('circle')
                                              .attr('cx', 0)
                                              .attr('cy', 0)
                                              .attr('r', 150)
                                              .style('fill', 'none')
                                              .style('stroke', 'black')
                                              .attr("transform", "translate(" + (600-3*50) / 2 + "," + (400-50) / 2 + ")");
                        updateBarsAnimated("Race");
                        updateLegend("Race");
                        updateButtons( "Race" );

                    };


                    requestData();
                });


        </script>
    </body>

</html>
